<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Money - Indian Pay</title>
    <!-- Fonts और Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- बाकी पेजों जैसा ही CSS --- */
        :root { --primary-color: #00a884; --secondary-color: #1f2937; --text-color: #334155; --bg-color: #f8fafc; --card-bg: #ffffff; --danger-color: #ef4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Montserrat', sans-serif; background-color: var(--bg-color); color: var(--text-color); }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 1.5rem; }
        h1, h2, h3 { color: var(--secondary-color); font-weight: 700; }
        
        /* Header */
        .header { background-color: var(--card-bg); padding: 1rem 0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .navbar { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.8rem; font-weight: 700; color: var(--secondary-color); text-decoration: none; }
        .logo span { color: var(--primary-color); }
        .nav-links { display: flex; align-items: center; gap: 1.5rem; }
        .nav-links .welcome-text { font-weight: 500; }
        .nav-links .logout-btn { background-color: var(--danger-color); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background-color 0.3s ease; }
        
        /* Main Content */
        main { padding: 3rem 0; }
        .page-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; }
        .page-header a { background: var(--card-bg); border: 1px solid #e5e7eb; color: var(--secondary-color); width: 40px; height: 40px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 1.2rem; text-decoration: none; transition: background-color 0.3s; }
        .page-header a:hover { background-color: #f3f4f6; }
        .page-header h1 { font-size: 2.5rem; }

        /* Add Money Card */
        .add-money-card {
            background: var(--card-bg);
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.07);
            max-width: 600px;
            margin: 0 auto 3rem auto;
        }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 0.75rem; font-size: 1rem; }
        .form-control { width: 100%; padding: 0.9rem 1rem; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; font-family: 'Montserrat', sans-serif; }
        .form-control:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 168, 132, 0.15); }
        .add-money-btn { width: 100%; padding: 1rem; border: none; background-color: var(--primary-color); color: white; font-size: 1.1rem; font-weight: 700; border-radius: 8px; cursor: pointer; transition: background-color 0.3s ease; }
        .add-money-btn:hover { background-color: #008a6e; }
        
        /* Footer & Alerts (पहले जैसा) */
        .footer { background-color: var(--secondary-color); color: #e2e8f0; padding: 4rem 0 2rem; text-align: center; }
        .footer .logo { color: white; }
        .footer .copyright { font-size: 0.9rem; margin-top: 2rem; border-top: 1px solid #334155; padding-top: 2rem; }
        .custom-alert-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center; }
        .custom-alert-box { background: var(--card-bg); color: var(--text-color); padding: 2.5rem; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 90%; max-width: 450px; text-align: center; }
        .custom-alert-box h3 { font-size: 1.5rem; margin-bottom: 1rem; }
        .custom-alert-box button { background-color: var(--primary-color); color: white; border: none; padding: 0.8rem 2rem; border-radius: 8px; font-size: 1rem; cursor: pointer; }

        /* Current Balance Display on Add Money page */
        .current-balance-display {
            background-color: #e0f2f1; /* Light primary color */
            color: var(--secondary-color);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            font-size: 1.2rem;
            font-weight: 600;
            text-align: center;
        }
        .current-balance-display span {
            color: var(--primary-color);
            font-weight: 700;
            font-size: 1.5rem;
        }

        /* Loader Overlay (signup.html से) */
        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s ease; }
        .loader-spinner { border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1.5s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Payment Overlay (signup.html से) */
        .payment-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 10000; justify-content: center; align-items: center; flex-direction: column; color: white; }
        .payment-box { background: white; color: black; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.3); width: 90%; max-width: 350px; }
        #payment-qr-code { margin: 15px 0; }
        #payment-qr-code img { width: 200px; height: 200px; margin: auto; display: block; }
        .payment-box p { margin: 10px 0; font-size: 1.1rem; }
        .payment-box button { background-color: var(--primary-color); color: white; border: none; padding: 12px 25px; border-radius: 8px; font-size: 16px; font-weight: 600; margin-top: 15px; cursor: pointer; transition: background-color 0.3s; }
        .payment-box button:hover { background-color: #008a6e; }
        .payment-box .small { color: #64748b; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div id="loader-overlay"><div class="loader-spinner"></div></div>

    <!-- Payment Overlay (signup.html से लिया गया और संशोधित) -->
    <div id="payment-overlay" class="payment-overlay">
        <div class="payment-box" id="qr-payment-box">
            <h3>Scan to Pay</h3>
            <p><strong>कृपया नीचे दी गई UPI ID या QR कोड का उपयोग करके <span id="qr-amount-display">₹--.--</span> का भुगतान करें।</strong></p>
            <div id="payment-qr-code"></div>
            <p>हमारी UPI ID: <strong><span id="qr-upi-id-display">N/A</span></strong></p>
            <p class="small">भुगतान करने के बाद, कृपया 'I have paid, enter UTR' पर क्लिक करें।</p>
            <button onclick="showUtrInputScreen()">I have paid, enter UTR</button>
            <button onclick="hidePaymentOverlay()" style="background-color: #6c757d; margin-top: 10px;">Cancel</button>
        </div>

        <div class="payment-box" id="utr-input-box" style="display: none;">
            <h3>Verify Payment</h3>
            <p>कृपया अपने भुगतान ऐप से 12 अंकों का UPI Transaction ID (UTR) दर्ज करें।</p>
            <div class="form-group" style="margin-bottom: 1rem;">
                <label for="utr-input">UPI UTR / Transaction ID</label>
                <input type="text" id="utr-input" class="form-control" placeholder="Enter 12-digit UTR" maxlength="12" required>
            </div>
            <button onclick="submitUtrForVerification()">Submit UTR for Verification</button>
            <button onclick="showQrPaymentScreen()" style="background-color: #6c757d; margin-top: 10px;">Back to QR</button>
        </div>
    </div>
    <div id="custom-alert" class="custom-alert-overlay"></div>

    <header class="header">
        <div class="container">
            <nav class="navbar">
                <a href="home.html" class="logo">Indian<span>Pay</span></a>
                <div class="nav-links">
                    <span class="welcome-text">Welcome, <strong id="user-name">User</strong></span>
                    <button id="logout-btn" class="logout-btn">Logout</button>
                </div>
            </nav>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="page-header">
                <a href="home.html" title="Back to Dashboard"><i class="fa-solid fa-arrow-left"></i></a>
                <h1>Add Money to Wallet</h1>
            </div>

            <div class="current-balance-display">
                Current Wallet Balance: <span id="current-wallet-balance">₹--.--</span>
            </div>

            <!-- Add Money Form -->
            <div class="add-money-card">
                <form id="add-money-form">
                    <div class="form-group">
                        <label for="amount">Amount to Add (₹)</label>
                        <input type="number" id="amount" class="form-control" placeholder="Enter amount" required min="10">
                    </div>
                    <button type="submit" class="add-money-btn">Proceed to Pay</button>
                </form>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <a href="home.html" class="logo">Indian<span>Pay</span></a>
            <p class="copyright">&copy; 2024 Indian Pay. All Rights Reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyCf2jwqT1wn5lOBucXUSblJnuFYBbWPtpw",
            authDomain: "indianpay425.firebaseapp.com",
            projectId: "indianpay425",
            storageBucket: "indianpay425.appspot.com",
            messagingSenderId: "6705555817",
            appId: "1:6705555817:web:0f220b2ffa3f10cdceb5f8"
        };
        
        // DOM Elements
        const userNameEl = document.getElementById('user-name');
        const currentWalletBalanceEl = document.getElementById('current-wallet-balance');
        const logoutBtn = document.getElementById('logout-btn');
        const addMoneyForm = document.getElementById('add-money-form');
        const loaderOverlay = document.getElementById('loader-overlay');
        const paymentOverlay = document.getElementById('payment-overlay');
        const qrPaymentBox = document.getElementById('qr-payment-box');
        const utrInputBox = document.getElementById('utr-input-box');
        const paymentQrCodeDiv = document.getElementById('payment-qr-code'); 
        const qrAmountDisplay = document.getElementById('qr-amount-display');
        const qrUpiIdDisplay = document.getElementById('qr-upi-id-display');
        const utrInput = document.getElementById('utr-input');
        const customAlert = document.getElementById('custom-alert');

        let currentUser = null; 
        let currentUserData = null; 
        let appSettings = null; 

        // Flags to ensure loader hides after all critical data is fetched
        let userDataInitialLoaded = false;
        let appSettingsInitialLoaded = false;

        // लोडर फंक्शंस
        function showLoader() {
            loaderOverlay.style.display = 'flex';
            loaderOverlay.style.opacity = '1';
        }
        function hideLoader() {
            loaderOverlay.style.opacity = '0';
            setTimeout(() => { loaderOverlay.style.display = 'none'; }, 500);
        }

        // यह फंक्शन जांचता है कि दोनों महत्वपूर्ण डेटा लोड हो गए हैं या नहीं
        function checkAndHideLoader() {
            if (userDataInitialLoaded && appSettingsInitialLoaded) {
                hideLoader();
            }
        }
        
        // स्क्रिप्ट लोड होते ही लोडर दिखाएं
        showLoader();

        try {
            firebase.initializeApp(firebaseConfig);
        } catch (e) {
            console.error("Error initializing Firebase:", e);
            showAlert("Error", "Firebase initialization failed. Please try again or contact support.");
            hideLoader(); // Firebase init fail पर लोडर छिपाएं
            // userDataInitialLoaded = true; // Error पर भी इसे true मानें ताकि लोडर छिप सके
            // appSettingsInitialLoaded = true; // Error पर भी इसे true मानें ताकि लोडर छिप सके
            // checkAndHideLoader();
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();


        // कस्टम अलर्ट के फंक्शन
        function showAlert(title, message, callback) { 
            customAlert.innerHTML = `<div class="custom-alert-box"><h3>${title}</h3><p>${message}</p><button id="alert-ok-btn-dynamic">OK</button></div>`; 
            customAlert.style.display = 'flex'; 
            document.getElementById('alert-ok-btn-dynamic').addEventListener('click', () => { 
                customAlert.style.display = 'none'; 
                if (typeof callback === 'function') callback(); 
            }); 
        }

        // भुगतान ओवरले फंक्शंस
        function hidePaymentOverlay() {
            paymentOverlay.style.display = 'none';
            paymentQrCodeDiv.innerHTML = ''; 
            utrInput.value = ''; 
        }

        function showQrPaymentScreen() { 
            if (!appSettings || !appSettings.paymentUpiId || !currentUserData) {
                showAlert("Error", "Payment details or user data incomplete. Please refresh and try again.");
                hidePaymentOverlay();
                return;
            }
            
            const amountToAdd = parseFloat(document.getElementById('amount').value);
            if (isNaN(amountToAdd) || amountToAdd <= 0) {
                showAlert('Invalid Amount', 'Please enter a valid amount greater than zero.');
                hidePaymentOverlay(); 
                return;
            }
            if (amountToAdd < 10) { 
                showAlert('Minimum Amount', 'Minimum amount to add is ₹10.');
                hidePaymentOverlay();
                return;
            }

            const upiId = appSettings.paymentUpiId; 
            const paymentUrl = `upi://pay?pa=${upiId}&pn=IndianPay&am=${amountToAdd}&cu=INR&tn=AddMoney_${currentUser.uid}`; 
            
            qrAmountDisplay.textContent = `₹${amountToAdd.toFixed(2)}`;
            qrUpiIdDisplay.textContent = upiId;
            paymentQrCodeDiv.innerHTML = ''; 
            new QRCode(paymentQrCodeDiv, { text: paymentUrl, width: 200, height: 200 }); 
            
            qrPaymentBox.style.display = 'block';
            utrInputBox.style.display = 'none';
            paymentOverlay.style.display = 'flex'; 
        }

        function showUtrInputScreen() {
            qrPaymentBox.style.display = 'none';
            utrInputBox.style.display = 'block';
            utrInput.value = ''; 
        }

        async function submitUtrForVerification() { 
            const amountToAdd = parseFloat(document.getElementById('amount').value); 
            const utrNumber = utrInput.value.trim();

            if (isNaN(amountToAdd) || amountToAdd <= 0) {
                showAlert('Invalid Amount', 'Please enter a valid amount greater than zero.');
                return;
            }
            if (utrNumber.length !== 12 || !/^\d+$/.test(utrNumber)) {
                showAlert('Invalid UTR', 'Please enter a valid 12-digit UPI UTR / Transaction ID.');
                return;
            }
            if (!currentUser || !currentUser.uid || !currentUserData) {
                showAlert('Error', 'User data not loaded. Please try logging in again.');
                return;
            }

            showLoader(); 

            try {
                await db.collection('addMoneyRequests').add({
                    userId: currentUser.uid,
                    userName: currentUserData.fullName || 'Unknown User',
                    userEmail: currentUserData.email || 'N/A',
                    mobileNumber: currentUserData.mobileNumber || 'N/A',
                    amount: amountToAdd,
                    utrNumber: utrNumber,
                    status: 'pending', 
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                hideLoader();
                hidePaymentOverlay();
                showAlert('Request Submitted', 'Your add money request has been submitted successfully and is awaiting admin approval. Your wallet balance will be updated after verification.');
                addMoneyForm.reset(); 

            } catch (error) {
                hideLoader();
                hidePaymentOverlay();
                console.error("Error submitting add money request: ", error);
                showAlert('Error', 'An error occurred while submitting your request: ' + error.message);
            }
        }

        // Logout
        logoutBtn.addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.href = 'index.html'; // Logout पर index.html पर रीडायरेक्ट करें
            });
        });

        // Login की जाँच और डेटा लोड करना
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                const userDocRef = db.collection('users').doc(user.uid);

                // रियल-टाइम लिसनर ताकि बैलेंस और नाम तुरंत अपडेट हो
                userDocRef.onSnapshot(doc => {
                    if (doc.exists) {
                        currentUserData = doc.data(); 
                        userNameEl.textContent = currentUserData.fullName || 'User';
                        currentWalletBalanceEl.textContent = `₹${(currentUserData.walletBalance || 0).toFixed(2)}`;
                        if (!userDataInitialLoaded) {
                            userDataInitialLoaded = true;
                            checkAndHideLoader();
                        }
                    } else {
                        showAlert("Error", "User data not found. Logging out.", () => {
                            auth.signOut();
                        });
                        if (!userDataInitialLoaded) { // User doc exist नहीं करता पर फिर भी loader हटाओ
                            userDataInitialLoaded = true;
                            checkAndHideLoader();
                        }
                    }
                }, error => {
                    console.error("Error listening to user data:", error);
                    showAlert("Error", "Could not fetch user data. Logging out.", () => {
                        auth.signOut();
                    });
                    if (!userDataInitialLoaded) { // Snapshot error पर भी loader हटाओ
                        userDataInitialLoaded = true;
                        checkAndHideLoader();
                    }
                });

                // app_settings से UPI ID लोड करें
                db.collection('app_settings').doc('config').get().then(doc => {
                    if (doc.exists && doc.data().paymentUpiId) {
                        appSettings = doc.data();
                    } else {
                        console.error("Error: 'app_settings/config' document or 'paymentUpiId' field not found!");
                        showAlert("Configuration Error", "Admin needs to set up UPI ID in Firestore settings for Add Money.");
                    }
                    if (!appSettingsInitialLoaded) {
                        appSettingsInitialLoaded = true;
                        checkAndHideLoader();
                    }
                }).catch(error => {
                    console.error("Firestore Error fetching app settings! ", error);
                    showAlert("Error", "Error fetching payment configuration. Please try again later.");
                    if (!appSettingsInitialLoaded) { // App settings fetch error पर भी loader हटाओ
                        appSettingsInitialLoaded = true;
                        checkAndHideLoader();
                    }
                });

            } else {
                hideLoader(); // user लॉग इन नहीं है तो loader हटाओ
                window.location.href = 'index.html'; 
            }
        });

        // Add Money Form Submit Event
        addMoneyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('amount').value);

            // Validation
            if (isNaN(amount) || amount <= 0) {
                showAlert('Invalid Amount', 'Please enter a valid amount greater than zero.');
                return;
            }
            if (amount < 10) { 
                showAlert('Minimum Amount', 'Minimum amount to add is ₹10.');
                return;
            }

            if (!appSettings || !appSettings.paymentUpiId) {
                showAlert('Configuration Error', 'Payment configuration is not available. Please try again later.');
                return;
            }
            if (!currentUserData) {
                showAlert('User Data Error', 'User data is not fully loaded. Please wait a moment or refresh.');
                return;
            }

            // QR भुगतान स्क्रीन दिखाएँ
            showQrPaymentScreen();
        });
    </script>
</body>
</html>
