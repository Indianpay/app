    <!-- इस पूरे स्क्रिप्ट टैग को कॉपी करके अपने पुराने वाले से बदलें -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = { 
            apiKey: "AIzaSyCf2jwqT1wn5lOBucXUSblJnuFYBbWPtpw",
            authDomain: "indianpay425.firebaseapp.com",
            projectId: "indianpay425",
            storageBucket: "indianpay425.appspot.com",
            messagingSenderId: "6705555817",
            appId: "1:6705555817:web:0f220b2ffa3f10cdceb5f8"
        };
        
        // --- Initialize Firebase ---
        try {
            firebase.initializeApp(firebaseConfig);
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            document.body.innerHTML = "<h1>Error: Could not connect to the service. Please try again later.</h1>";
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Service to Permission Mapping ---
        const userPermissionMap = {
            'cash-withdrawal': 'moneytransfer', 'aadhaar-pay': 'moneytransfer', 'balance-inquiry': 'moneytransfer', 'mini-statement': 'moneytransfer',
            'mobile-recharge': 'recharge', 'money-transfer': 'recharge', 'dth-recharge': 'recharge',
            'broadband': 'billpay', 'electricity': 'billpay', 'cable-tv': 'billpay', 'water-bill': 'billpay', 'gas-cylinder': 'billpay', 'landline': 'billpay', 'loan-repayment': 'billpay', 'insurance': 'billpay', 'fastag-recharge': 'billpay', 'credit-card-bill': 'billpay', 'municipal-taxes': 'billpay', 'education-fees': 'billpay',
            'pan-card-services': 'govtservices', 'aadhaar-services': 'govtservices', 'voter-id-card': 'govtservices', 'driving-license': 'govtservices', 'passport-seva': 'govtservices', 'birth-certificate': 'govtservices', 'death-certificate': 'govtservices', 'land-records': 'govtservices', 'ration-card': 'govtservices', 'e-district-services': 'govtservices',
            'itr-filing': 'financialservices', 'gst-services': 'financialservices', 'life-insurance': 'financialservices', 'vehicle-insurance': 'financialservices', 'health-insurance': 'financialservices', 'fastag-services': 'financialservices', 'loan-services': 'financialservices', 'credit-card-apply': 'financialservices', 'demat-account': 'financialservices', 'cibil-score': 'financialservices',
            'pm-kisan': 'schemesservices', 'ayushman-bharat': 'schemesservices', 'e-shram-card': 'schemesservices', 'pradhan-mantri-fasal-bima': 'schemesservices', 'pension-yojana': 'schemesservices', 'scholarship-schemes': 'schemesservices',
            'train-tickets': 'travelservices', 'flight-tickets': 'travelservices', 'bus-tickets': 'travelservices', 'hotel-booking': 'travelservices',
            'university-admission': 'educationservices', 'exam-results': 'educationservices', 'govt-job-apply': 'educationservices', 'skill-india': 'educationservices',
            'e-stamp-paper': 'utilityservices', 'digital-signature': 'utilityservices', 'e-court-services': 'utilityservices', 'rtionline': 'utilityservices'
        };

        // --- Custom Alert Functions ---
        function showAlert(title, message) {
            const customAlertOverlay = document.getElementById('custom-alert');
            if (customAlertOverlay) {
                customAlertOverlay.innerHTML = `<div class="custom-alert-box"><h3>${title}</h3><p>${message}</p><button onclick="closeAlert()">OK</button></div>`;
                customAlertOverlay.style.display = 'flex';
            } else {
                alert(`${title}\n${message}`); // Fallback to browser alert
            }
        }
        function closeAlert() {
            const customAlertOverlay = document.getElementById('custom-alert');
            if (customAlertOverlay) customAlertOverlay.style.display = 'none';
        }

        // --- Main Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => auth.signOut());
            }

            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is signed in, fetch data
                    try {
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            updateUserInfo(userData);
                            
                            if (userData.isBlocked === true) {
                                showBlockedScreen();
                                return;
                            }
                            
                            // Fetch master settings and then apply all permissions
                            const settingsDoc = await db.collection('settings').doc('masterServices').get();
                            const masterSettings = settingsDoc.exists ? settingsDoc.data() : {};
                            applyServicePermissions(userData, masterSettings);

                        } else {
                            console.error("User data not found in Firestore.");
                            auth.signOut();
                        }
                    } catch (error) {
                        console.error("Error fetching user or settings data:", error);
                        showAlert("Error", "Could not load your data. Please check your connection.");
                    }
                } else {
                    // User is signed out
                    window.location.href = 'index.html';
                }
            });
        });

        function updateUserInfo(userData) {
            const userNameEl = document.getElementById('user-name');
            const walletBalanceEl = document.getElementById('wallet-balance');
            
            if (userNameEl) userNameEl.textContent = userData.fullName || 'User';
            if (walletBalanceEl) walletBalanceEl.textContent = `₹${(userData.walletBalance || 0).toFixed(2)}`;
        }

        function showBlockedScreen() {
            const blockedOverlay = document.getElementById('blocked-overlay');
            if (blockedOverlay) {
                blockedOverlay.innerHTML = `<div class="blocked-box"><h2>Account Blocked</h2><p>Your account is blocked. Please contact support.</p></div>`;
                blockedOverlay.style.display = 'flex';
                setTimeout(() => auth.signOut(), 5000);
            }
        }

        function applyServicePermissions(userData, masterSettings) {
            const allServiceSections = document.querySelectorAll('.service-section');
            if (!allServiceSections.length) return; // If no sections found, do nothing

            allServiceSections.forEach(section => {
                const serviceCardsInSection = section.querySelectorAll('.service-card');
                let visibleServicesCount = 0;

                serviceCardsInSection.forEach(card => {
                    const serviceId = card.dataset.serviceId;
                    if (!serviceId) return; // Skip if card has no service-id

                    // 1. Master Control Check: Hide if service is false globally
                    if (masterSettings[serviceId] === false) {
                        card.style.display = 'none';
                        return; // Stop processing for this card
                    }
                    
                    // If not hidden by master, make it visible by default
                    card.style.display = '';
                    visibleServicesCount++;

                    // 2. User Permission Check: Disable if user doesn't have permission
                    const permissionCategory = userPermissionMap[serviceId];
                    if (permissionCategory && userData[permissionCategory] === false) {
                        card.href = "#"; // Prevent navigation
                        card.style.opacity = '0.6'; // Make it look disabled
                        card.style.cursor = 'not-allowed';

                        // Remove old event listeners and add a new one for the alert
                        const newCard = card.cloneNode(true);
                        card.parentNode.replaceChild(newCard, card);
                        
                        newCard.addEventListener('click', (event) => {
                            event.preventDefault();
                            showAlert('Service Not Active', 'This service is not available for your account.');
                        });
                    }
                });

                // 3. Section Visibility Check: Hide entire section if it's empty
                if (visibleServicesCount === 0) {
                    section.style.display = 'none';
                } else {
                    section.style.display = 'block';
                }
            });
        }
    </script>
