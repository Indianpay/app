<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Recharge - Indian Pay</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary-color: #00a884; --secondary-color: #1f2937; --text-color: #334155; --bg-color: #f8fafc; --card-bg: #ffffff; --danger-color: #ef4444; --success-color: #16a34a; --pending-color: #f59e0b;}
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Montserrat', sans-serif; background-color: var(--bg-color); color: var(--text-color); }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 1.5rem; }
        .header { background-color: var(--card-bg); padding: 1rem 0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .navbar { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.8rem; font-weight: 700; color: var(--secondary-color); text-decoration: none; }
        .logo span { color: var(--primary-color); }
        .nav-links { display: flex; align-items: center; gap: 1.5rem; }
        .nav-links .welcome-text { font-weight: 500; }
        .nav-links .logout-btn { background-color: var(--danger-color); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; font-weight: 600; cursor: pointer; }
        main { padding: 3rem 0; }
        .page-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; }
        .page-header a { background: var(--card-bg); border: 1px solid #e5e7eb; color: var(--secondary-color); width: 40px; height: 40px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; text-decoration: none; }
        .page-header h1 { font-size: 2.5rem; }
        .recharge-card { background: var(--card-bg); padding: 2.5rem; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.07); max-width: 600px; margin: 0 auto 3rem auto; }
        .form-group { margin-bottom: 1.5rem; position: relative; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 0.75rem; font-size: 1rem; }
        .form-control { width: 100%; padding: 0.9rem 1rem; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; background-color: #fff; }
        .input-loader { position: absolute; right: 1rem; top: 55%; display: none; }
        .browse-plans-btn { display: block; text-align: right; font-size: 0.9rem; color: var(--primary-color); text-decoration: none; margin-top: 0.5rem; font-weight: 600; cursor: pointer; }
        .recharge-btn { width: 100%; padding: 1rem; border: none; background-color: var(--primary-color); color: white; font-size: 1.1rem; font-weight: 700; border-radius: 8px; cursor: pointer; }
        .recharge-btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center; }
        .modal-box { background: var(--bg-color); width: 95%; max-width: 800px; height: 80%; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        .modal-header { padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 1.3rem; }
        .modal-close-btn { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--text-color); }
        .modal-body { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }
        .plan-category { margin-bottom: 2rem; }
        .plan-category h4 { font-size: 1.1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--primary-color); margin-bottom: 1rem; }
        .plan-item { background: var(--card-bg); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #e5e7eb; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .plan-item:hover { transform: translateY(-3px); box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .plan-item .price { font-size: 1.4rem; font-weight: 700; color: var(--primary-color); }
        .plan-item .validity { font-weight: 600; font-size: 0.9rem; }
        .plan-item .desc { font-size: 0.9rem; margin-top: 0.5rem; color: #64748b; }
        .plan-details { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .custom-alert-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center; }
        .custom-alert-box { background: var(--card-bg); padding: 2.5rem; border-radius: 16px; width: 90%; max-width: 450px; text-align: center; }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <nav class="navbar">
                <a href="home.html" class="logo">Indian<span>Pay</span></a>
                <div class="nav-links">
                    <span class="welcome-text">Welcome, <strong id="user-name">User</strong></span>
                    <button id="logout-btn" class="logout-btn">Logout</button>
                </div>
            </nav>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="page-header">
                <a href="home.html" title="Back to Dashboard"><i class="fa-solid fa-arrow-left"></i></a>
                <h1>Mobile Recharge</h1>
            </div>

            <div class="recharge-card">
                <form id="recharge-form" onsubmit="return false;">
                    <div class="form-group">
                        <label for="mobile-number">Mobile Number</label>
                        <input type="tel" id="mobile-number" class="form-control" placeholder="Enter 10-digit number to fetch operator" maxlength="10" required>
                        <span class="input-loader" id="operator-loader">üîç</span>
                    </div>
                    <div class="form-group">
                        <label for="operator-select">Operator</label>
                        <select id="operator-select" class="form-control" required>
                            <option value="" disabled selected>Select Operator</option>
                            <option value="Airtel">Airtel</option>
                            <option value="Jio">Jio</option>
                            <option value="Vi">Vi (Vodafone Idea)</option>
                            <option value="BSNL">BSNL</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="circle-select">Circle (State)</label>
                        <select id="circle-select" class="form-control" required>
                            <option value="" disabled selected>Select Circle</option>
                            <option value="Andhra Pradesh Telengana">Andhra Pradesh & Telengana</option>
                            <option value="Assam">Assam</option>
                            <option value="Bihar Jharkhand">Bihar & Jharkhand</option>
                            <option value="Chennai">Chennai</option>
                            <option value="Delhi NCR">Delhi NCR</option>
                            <option value="Gujarat">Gujarat</option>
                            <option value="Haryana">Haryana</option>
                            <option value="Himachal Pradesh">Himachal Pradesh</option>
                            <option value="Jammu Kashmir">Jammu & Kashmir</option>
                            <option value="Karnataka">Karnataka</option>
                            <option value="Kerala">Kerala</option>
                            <option value="Kolkata">Kolkata</option>
                            <option value="Madhya Pradesh Chhattisgarh">Madhya Pradesh & Chhattisgarh</option>
                            <option value="Maharashtra Goa">Maharashtra & Goa</option>
                            <option value="Mumbai">Mumbai</option>
                            <option value="North East">North East</option>
                            <option value="Odisha">Odisha</option>
                            <option value="Punjab">Punjab</option>
                            <option value="Rajasthan">Rajasthan</option>
                            <option value="Tamil Nadu">Tamil Nadu</option>
                            <option value="UP East">UP East</option>
                            <option value="UP West">UP West</option>
                            <option value="West Bengal">West Bengal</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="amount">Amount (‚Çπ)</label>
                        <input type="number" id="amount" class="form-control" placeholder="Enter recharge amount" required>
                        <a class="browse-plans-btn" id="browse-plans-btn">Browse Plans</a>
                    </div>
                    <button type="button" id="recharge-btn" class="recharge-btn">Proceed to Recharge</button>
                </form>
            </div>
            
            <div class="recent-recharges"><!-- Your Recent Recharges Table HTML --></div>
        </div>
    </main>

    <footer class="footer"><!-- Your Footer HTML --></footer>
    <div id="custom-alert" class="custom-alert-overlay"></div>

    <div id="plans-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3 id="plans-modal-title">Recharge Plans</h3>
                <button id="modal-close-btn" class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body" id="plans-list"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        // --- 1. Firebase Configuration ---
        const firebaseConfig = { 
            apiKey: "AIzaSyCf2jwqT1wn5lOBucXUSblJnuFYBbWPtpw",
            authDomain: "indianpay425.firebaseapp.com",
            projectId: "indianpay425",
            storageBucket: "indianpay425.appspot.com",
            messagingSenderId: "6705555817",
            appId: "1:6705555817:web:0f220b2ffa3f10cdceb5f8"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- 2. API CONFIGURATIONS ---
        const PLAN_API_USER_ID = "6403";
        const PLAN_API_PASSWORD = "Sattu@2122";
        const PLAN_API_BASE_URL = "https://planapi.in/api/Mobile/";
        const RECHARGE_API_TOKEN = "9a93634f-165e-4dac-be00-9558b2e69a62";
        const RECHARGE_API_BASE_URL = "https://ultra.myfinpaypro.co.in/api/Service/";

        // --- 3. PLAN API OPERATOR CODES (‡§∏‡§π‡•Ä ‡§µ‡§æ‡§≤‡•á) ---
        const PLAN_API_OP_CODES = {
            'Airtel': '25',
            'Jio': '11',
            'Vi': '24',
            'BSNL': '4'
        };

        // --- 4. PLAN API CIRCLE CODES (‡§∏‡§π‡•Ä ‡§µ‡§æ‡§≤‡•á) ---
        const PLAN_API_CIRCLE_CODES = {
            'Andhra Pradesh Telengana': '23',
            'Assam': '16',
            'Bihar Jharkhand': '52',
            'Chennai': '49',
            'Delhi NCR': '10',
            'Gujarat': '98',
            'Haryana': '96',
            'Himachal Pradesh': '95',
            'Jammu Kashmir': '94',
            'Karnataka': '91',
            'Kerala': '40',
            'Kolkata': '31',
            'Madhya Pradesh Chhattisgarh': '93',
            'Maharashtra Goa': '92',
            'Mumbai': '54',
            'North East': '16', // NESA
            'Odisha': '56',
            'Punjab': '02',
            'Rajasthan': '79',
            'Tamil Nadu': '94',
            'UP East': '03',
            'UP West': '97',
            'West Bengal': '53'
        };

        // --- 5. RECHARGE API OPERATOR CODES (myfinpaypro) ---
        const RECHARGE_API_OP_CODES = {
            'Airtel': 'AP',
            'Jio': 'JO',
            'Vi': 'VI',
            'BSNL': 'BS'
        };

        // --- 6. DOM Elements ---
        const mobileNumberInput = document.getElementById('mobile-number');
        const operatorSelect = document.getElementById('operator-select');
        const circleSelect = document.getElementById('circle-select');
        const amountInput = document.getElementById('amount');
        const operatorLoader = document.getElementById('operator-loader');
        const browsePlansBtn = document.getElementById('browse-plans-btn');
        const rechargeBtn = document.getElementById('recharge-btn');
        const plansModal = document.getElementById('plans-modal');
        const plansModalTitle = document.getElementById('plans-modal-title');
        const plansListContainer = document.getElementById('plans-list');
        const closeModalBtn = document.getElementById('modal-close-btn');
        const customAlert = document.getElementById('custom-alert');
        const userNameEl = document.getElementById('user-name');
        const logoutBtn = document.getElementById('logout-btn');

        // --- 7. Global Variables ---
        let currentOperatorData = null; 
        let currentUser = null;
        let currentUserData = null;

        // --- 8. Auth and Alert Functions ---
        function showAlert(title, message) { customAlert.innerHTML = `<div class="custom-alert-box"><h3>${title}</h3><p>${message}</p><button onclick="closeAlert()">OK</button></div>`; customAlert.style.display = 'flex'; }
        function closeAlert() { customAlert.style.display = 'none'; }
        
        logoutBtn.addEventListener('click', () => auth.signOut());

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                db.collection('users').doc(user.uid).get().then(doc => {
                    if (doc.exists) {
                        currentUserData = doc.data();
                        userNameEl.textContent = currentUserData.fullName || 'User';
                    }
                });
            } else {
                window.location.href = 'index.html';
            }
        });

        // --- 9. Event Listeners ---
        mobileNumberInput.addEventListener('blur', async () => {
            if (mobileNumberInput.value.trim().length === 10) {
                await fetchOperatorAndCircle(mobileNumberInput.value.trim());
            }
        });

        browsePlansBtn.addEventListener('click', () => {
            let opCode, circleCode, operatorName, circleName;
            
            if (currentOperatorData && currentOperatorData.OpCode && currentOperatorData.CircleCode) {
                opCode = currentOperatorData.OpCode;
                circleCode = currentOperatorData.CircleCode;
                operatorName = currentOperatorData.Operator;
                circleName = currentOperatorData.Circle;
            } else {
                operatorName = operatorSelect.value;
                circleName = circleSelect.value;
                opCode = PLAN_API_OP_CODES[operatorName];
                circleCode = PLAN_API_CIRCLE_CODES[circleName];
            }
            
            if (!opCode || !circleCode) {
                return showAlert('Info', 'Please select both Operator and Circle to browse plans.');
            }
            
            openPlansModal();
            fetchPlans(opCode, circleCode, operatorName, circleName);
        });
        
        rechargeBtn.addEventListener('click', processRecharge);
        closeModalBtn.addEventListener('click', closePlansModal);
        plansModal.addEventListener('click', (e) => { if (e.target === plansModal) closePlansModal(); });
        
        plansListContainer.addEventListener('click', (e) => {
            const planItem = e.target.closest('.plan-item');
            if(planItem){
                amountInput.value = planItem.dataset.amount;
                closePlansModal();
            }
        });

        // --- 10. Core Functions ---
        async function fetchOperatorAndCircle(mobileNumber) {
            operatorLoader.style.display = 'block';
            currentOperatorData = null; 
            operatorSelect.value = "";
            circleSelect.value = "";

            const url = `${PLAN_API_BASE_URL}OperatorFetchNew?ApiUserID=${PLAN_API_USER_ID}&ApiPassword=${PLAN_API_PASSWORD}&Mobileno=${mobileNumber}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.ERROR === "0") {
                    currentOperatorData = data;
                    
                    for (let option of operatorSelect.options) {
                        if (data.Operator && option.text.toLowerCase().includes(data.Operator.toLowerCase())) {
                            option.selected = true;
                            break;
                        }
                    }
                    if (data.Circle) {
                        circleSelect.value = data.Circle;
                    }
                } else {
                    showAlert('Auto-detect Failed', `${data.Message || 'Unknown error'}. Please select Operator and Circle manually.`);
                }
            } catch (error) {
                console.error("Operator Fetch Error:", error);
                showAlert('Error', 'Auto-detect failed. Please select Operator and Circle manually.');
            } finally {
                operatorLoader.style.display = 'none';
            }
        }

        async function fetchPlans(opCode, circleCode, operatorName, circleName) {
            plansListContainer.innerHTML = '<p>Loading plans...</p>';
            plansModalTitle.textContent = `Plans for ${operatorName} (${circleName})`;

            const url = `${PLAN_API_BASE_URL}NewMobilePlans?apimember_id=${PLAN_API_USER_ID}&api_password=${PLAN_API_PASSWORD}&operatorcode=${opCode}&cricle=${circleCode}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if(data.ERROR === "0" && data.RDATA){
                    displayPlans(data.RDATA);
                } else {
                     plansListContainer.innerHTML = `<p>${data.MESSAGE || 'No plans found for this selection.'}</p>`;
                }
            } catch(error) {
                console.error("Plan Fetch Error:", error);
                plansListContainer.innerHTML = '<p>Could not load plans. Please try again later.</p>';
            }
        }

        function displayPlans(planData) {
            let html = '';
            for (const category in planData) {
                html += `<div class="plan-category"><h4>${category}</h4>`;
                const plans = planData[category];
                if(Array.isArray(plans)) {
                    plans.forEach(plan => {
                        html += `
                            <div class="plan-item" data-amount="${plan.rs}">
                                <div class="plan-details">
                                    <span class="price">‚Çπ ${plan.rs}</span>
                                    <span class="validity">Validity: ${plan.validity}</span>
                                </div>
                                <p class="desc">${plan.desc}</p>
                            </div>
                        `;
                    });
                }
                html += `</div>`;
            }
            plansListContainer.innerHTML = html || '<p>No plans available.</p>';
        }

        async function processRecharge() {
            // Recharge logic will be added here later
            showAlert('Coming Soon', 'Recharge functionality will be connected soon.');
        }

        function openPlansModal() { plansModal.style.display = 'flex'; }
        function closePlansModal() { plansModal.style.display = 'none'; }
    </script>
</body>
</html>
