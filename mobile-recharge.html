<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Recharge - Indian Pay</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ... All CSS is the same ... */
    </style>
</head>
<body>
    <!-- ... All HTML is the same ... -->
    <main>
        <div class="container">
            <div class="recharge-card">
                <form id="recharge-form" onsubmit="return false;">
                    <!-- Form elements are the same -->
                </form>
            </div>
        </div>
    </main>
    <div id="custom-alert" class="custom-alert-overlay"></div>
    <div id="plans-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3 id="plans-modal-title">Recharge Plans</h3>
                <button id="modal-close-btn" class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body" id="plans-list"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        // --- 1. Firebase Configuration ---
        const firebaseConfig = { /* ... your firebase config ... */ };
        firebase.initializeApp(firebaseConfig);

        // --- 2. API CONFIGURATIONS ---
        const PLAN_API_USER_ID = "6403";
        const PLAN_API_PASSWORD = "Sattu@2122";
        const PLAN_API_BASE_URL = "https://planapi.in/api/Mobile/";
        
        // --- 3. PLAN API OPERATOR CODES (सही वाले) ---
        const PLAN_API_OP_CODES = {
            'Airtel': '25',
            'Jio': '11',
            'Vi': '24',
            'BSNL': '4'
        };

        // --- 4. PLAN API CIRCLE CODES (सही वाले) ---
        const PLAN_API_CIRCLE_CODES = {
            'Andhra Pradesh Telengana': '23',
            'Assam': '16',
            'Bihar Jharkhand': '52',
            'Chennai': '49',
            'Delhi NCR': '10',
            'Gujarat': '98',
            'Haryana': '96',
            'Himachal Pradesh': '95',
            'Jammu Kashmir': '94',
            'Karnataka': '91',
            'Kerala': '40',
            'Kolkata': '31',
            'Madhya Pradesh Chhattisgarh': '93',
            'Maharashtra Goa': '92',
            'Mumbai': '54',
            'North East': '16', // NESA
            'Odisha': '56',
            'Punjab': '02',
            'Rajasthan': '79',
            'Tamil Nadu': '94',
            'UP East': '03',
            'UP West': '97',
            'West Bengal': '53'
        };
        
        // --- All other variables and DOM elements are the same ---
        const operatorSelect = document.getElementById('operator-select');
        const circleSelect = document.getElementById('circle-select');
        const browsePlansBtn = document.getElementById('browse-plans-btn');
        const plansModal = document.getElementById('plans-modal');
        const plansListContainer = document.getElementById('plans-list');
        const closeModalBtn = document.getElementById('modal-close-btn');
        let currentOperatorData = null;

        // --- Event Listeners ---
        browsePlansBtn.addEventListener('click', () => {
            let opCode, circleCode, operatorName, circleName;
            
            if (currentOperatorData && currentOperatorData.OpCode && currentOperatorData.CircleCode) {
                opCode = currentOperatorData.OpCode;
                circleCode = currentOperatorData.CircleCode;
                operatorName = currentOperatorData.Operator;
                circleName = currentOperatorData.Circle;
            } else {
                operatorName = operatorSelect.value;
                circleName = circleSelect.value;
                opCode = PLAN_API_OP_CODES[operatorName];
                circleCode = PLAN_API_CIRCLE_CODES[circleName];
            }
            
            if (!opCode || !circleCode) {
                alert('Please select both Operator and Circle to browse plans.');
                return;
            }
            
            const url = `${PLAN_API_BASE_URL}NewMobilePlans?apimember_id=${PLAN_API_USER_ID}&api_password=${PLAN_API_PASSWORD}&operatorcode=${opCode}&circle=${circleCode}`;
            
            // --- THIS IS THE MOST IMPORTANT STEP ---
            alert("Please copy this URL and open it in a new browser tab:\n\n" + url);
            
            openPlansModal();
            fetchPlans(url, operatorName, circleName);
        });

        closeModalBtn.addEventListener('click', closePlansModal);
        plansModal.addEventListener('click', (e) => { if (e.target === plansModal) closePlansModal(); });

        // --- Core Functions ---
        async function fetchPlans(url, operatorName, circleName) {
            plansListContainer.innerHTML = '<p>Loading plans...</p>';
            plansModalTitle.textContent = `Plans for ${operatorName} (${circleName})`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if(data.ERROR === "0" && data.RDATA){
                    displayPlans(data.RDATA);
                } else {
                     plansListContainer.innerHTML = `<p>${data.MESSAGE || 'No plans found for this selection.'}</p>`;
                }
            } catch(error) {
                console.error("Plan Fetch Error:", error);
                plansListContainer.innerHTML = `<p>Could not load plans. Error: ${error.message}</p>`;
            }
        }

        function displayPlans(planData) {
            let html = '';
            for (const category in planData) {
                html += `<div class="plan-category"><h4>${category}</h4>`;
                const plans = planData[category];
                if(Array.isArray(plans)) {
                    plans.forEach(plan => {
                        html += `
                            <div class="plan-item" data-amount="${plan.rs}">
                                <div class="plan-details">
                                    <span class="price">₹ ${plan.rs}</span>
                                    <span class="validity">Validity: ${plan.validity}</span>
                                </div>
                                <p class="desc">${plan.desc}</p>
                            </div>
                        `;
                    });
                }
                html += `</div>`;
            }
            plansListContainer.innerHTML = html || '<p>No plans available.</p>';
        }

        function openPlansModal() { plansModal.style.display = 'flex'; }
        function closePlansModal() { plansModal.style.display = 'none'; }

        // --- All other functions (fetchOperatorAndCircle, recharge logic, etc.) are the same ---
        // Make sure to include them from the previous complete code block.
    </script>
</body>
</html>
